<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Mapfeel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  </head>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- <script src="/src/map.js"></script> -->
  <!-- <script src="/src/main.js"></script> -->
  
  <body>
    <div id="app">
      <div id="map" style="width:400px; height:400px;"></div>
    </div>
    <div id="poilist">
    </div>

    <!-- <script type="module" src="/src/main.js"></script> -->
    
    <script type="module">
      import { initMap, distance, getCenter } from "/src/map.js"
      // import { main } from "/src/main.js"
      import { getData } from "/src/data.js";

      var curpos = {}

      console.log('地図表示')
      const map = initMap();

      console.log('プロジェクト名取得')
      var project = location.pathname.replace(/^\//, "");
      if (!project) {
	  alert("URLにプロジェクト名を指定してください");
	  // return;
      }

      console.log('データ取得')
      var data = await getData(project);

      $('#poilist').empty()
      for(var i=0;i<data.length;i++){
		     /*
	  var li = $('<li>')
	  li.text(data[i].title)
		     $('#poilist').append(li)
		     */
          var e = $('<div>');
          e.text(data[i].title);		     
	  ${'#poilist').append(e);
      }
      
      map.on('moveend', function () {
          console.log("地図が動き終わった");
	  curpos = map.getCenter();

	  // dataをソート
	  for (var i = 0; i < data.length; i++) {
              var entry = data[i]
              entry.distance = distance(entry.pos.lat, entry.pos.lng, curpos.lat, curpos.lng)
	  }
	  data = data.sort((a, b) => { // 近い順にソート
              return a.distance > b.distance ? 1 : -1;
	  })

	  $('#poilist').empty();
          for(var i=0;i<data.length;i++){
	      var div = $('<div>')       
	      div.text(data[i].title + ' ' + data[i].description);
	      $('#poilist').append(div)
	      //var li = $('<li>')
	      //li.text(data[i].title + ' ' + data[i].description);
	      //$('#poilist').append(li)
	  }
      });

    </script>
  </body>
</html>

